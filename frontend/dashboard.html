<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script src="api.js"></script>
  <style>
    .dashboard-container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .back-link {
      display: inline-block;
      margin: 20px;
      color: #2563eb;
      text-decoration: none;
      font-weight: 600;
    }
    .back-link:hover {
      text-decoration: underline;
    }
    .export-btn {
      background: #16a34a;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 10px;
    }
    .export-btn:hover {
      background: #15803d;
    }
    .export-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    .table-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>

  <a href="index.html" class="back-link">‚Üê Back to Home</a>

  <div class="header">
    <div style="display: flex; justify-content: space-between; align-items: center; gap: 20px;">
      <div>
        <h1>Campus Events</h1>
        <h2>Attendance Dashboard</h2>
      </div>
      <div style="display: flex; gap: 10px;">
        <a href="checkin.html" class="dashboard-link">üì± Staff Check-In</a>
        <a href="create_event.html" class="dashboard-link">‚ûï Create Event</a>
      </div>
    </div>
  </div>

  <div class="dashboard-container">
    <!-- Event Selector -->
    <div class="dashboard-top">
      <select class="event-select" id="eventSelect" onchange="loadAttendanceData()">
        <option value="">Select an event</option>
      </select>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards">
      <div class="summary-card">
        <p>Total Registered</p>
        <h3 id="totalRegistered">0</h3>
      </div>
      <div class="summary-card">
        <p>Total Checked-in</p>
        <h3 id="totalCheckedIn">0</h3>
      </div>
    </div>

    <!-- Attendance Table -->
    <div class="table-header-row">
      <span></span>
      <button class="export-btn" id="exportBtn" onclick="exportCSV()" disabled>‚¨á Export CSV</button>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Student ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Check-in Status</th>
          </tr>
        </thead>
        <tbody id="attendanceTable">
          <tr>
            <td colspan="4" style="text-align: center; color: #9ca3af;">Select an event to view attendance</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

<script>
let allEvents = [];
let currentRegistrations = [];

function requireStaffAuth() {
    const staffAuthed = sessionStorage.getItem("staffAuthed");
    if (staffAuthed !== "true") {
        window.location.href = "index.html?staff=1";
        return false;
    }
    return true;
}

async function initializeDashboard() {
    await loadEventOptions();
}

async function loadEventOptions(selectedId = "") {
    allEvents = await fetchEvents();
    const eventSelect = document.getElementById('eventSelect');
    eventSelect.innerHTML = '<option value="">Select an event</option>';

    allEvents.forEach(event => {
        const option = document.createElement('option');
        option.value = event.id;
        option.textContent = event.title;
        eventSelect.appendChild(option);
    });

    if (selectedId) {
        eventSelect.value = String(selectedId);
    }
}

async function loadAttendanceData() {
    const eventSelect = document.getElementById('eventSelect');
    const selectedEventId = eventSelect.value;

    if (!selectedEventId) {
        document.getElementById('attendanceTable').innerHTML = `
            <tr>
                <td colspan="4" style="text-align: center; color: #9ca3af;">Select an event to view attendance</td>
            </tr>
        `;
        document.getElementById('totalRegistered').textContent = '0';
        document.getElementById('totalCheckedIn').textContent = '0';
        currentRegistrations = [];
        document.getElementById('exportBtn').disabled = true;
        return;
    }

    // Filter registrations and attendance for selected event
    const registrations = await fetch(`${API_BASE_URL}/events/${selectedEventId}/registrations`, {
        headers: getStaffHeaders(),
    })
        .then(r => r.ok ? r.json() : [])
        .catch(() => []);

    currentRegistrations = registrations;
    document.getElementById('exportBtn').disabled = registrations.length === 0;

    const totalRegistered = registrations.length;
    const totalCheckedIn = registrations.filter(r => r.checked_in_at).length;

    document.getElementById('totalRegistered').textContent = totalRegistered;
    document.getElementById('totalCheckedIn').textContent = totalCheckedIn;

    // Generate table rows
    const tableBody = document.getElementById('attendanceTable');
    
    if (registrations.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="4" style="text-align: center; color: #9ca3af;">No registrations for this event</td>
            </tr>
        `;
        return;
    }

    tableBody.innerHTML = registrations.map(reg => `
        <tr>
            <td>${reg.student_id}</td>
            <td>${reg.name}</td>
            <td>${reg.email}</td>
            <td>
                <span class="status ${reg.checked_in_at ? 'yes' : 'no'}">
                    ${reg.checked_in_at ? 'Checked In' : 'Not Checked In'}
                </span>
            </td>
        </tr>
    `).join('');
}

function exportCSV() {
    if (currentRegistrations.length === 0) return;

    const eventSelect = document.getElementById('eventSelect');
    const eventTitle = eventSelect.options[eventSelect.selectedIndex].text;

    const headers = ['Student ID', 'Name', 'Email', 'Check-in Status', 'Check-in Time'];
    const rows = currentRegistrations.map(reg => [
        reg.student_id,
        reg.name,
        reg.email,
        reg.checked_in_at ? 'Checked In' : 'Not Checked In',
        reg.checked_in_at ? new Date(reg.checked_in_at).toLocaleString() : '',
    ]);

    const csvContent = [headers, ...rows]
        .map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
        .join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `attendance_${eventTitle.replace(/\s+/g, '_')}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(() => URL.revokeObjectURL(url), 100);
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
    if (!requireStaffAuth()) {
        return;
    }
    initializeDashboard();
});
</script>

</body>
</html>
